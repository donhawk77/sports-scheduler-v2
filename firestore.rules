rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user matches the document ID
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Get user data
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check specific roles
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }

    function isAdmin() {
      return hasRole('admin') || 
             request.auth.token.email in [
               'don.hawk77@gmail.com', 
               'dhawk@valkyrieprosperity.com', 
               'admin@sportsscheduler.com', 
               'agent@valkyrie.com'
             ];
    }

    function isVenue() {
      return hasRole('venue');
    }

    function isCoach() {
      return hasRole('coach');
    }

    // --- Schema Validation Helpers ---
    
    function isValidString(text, minLen, maxLen) {
      return text is string && text.size() >= minLen && text.size() <= maxLen;
    }

    function isValidUser(data) {
      return (!('displayName' in data) || isValidString(data.displayName, 1, 100)) &&
             (!('email' in data) || isValidString(data.email, 5, 100)) &&
             (!('bio' in data) || isValidString(data.bio, 0, 1000));
    }

    function isValidBooking(data) {
      return (!('price_cents' in data) || (data.price_cents is number && data.price_cents >= 0)) &&
             (!('status' in data) || data.status in ['pending_payment', 'confirmed', 'cancelled', 'attended', 'no_show', 'failed_payment', 'failed_overbooked']) &&
             (!('paymentStatus' in data) || data.paymentStatus in ['unpaid', 'paid', 'refunded', 'paid_pending_refund']);
    }

    function isValidEvent(data) {
      return (!('title' in data) || isValidString(data.title, 1, 150)) &&
             (!('description' in data) || isValidString(data.description, 0, 5000)) &&
             (!('capacity' in data) || (
                data.capacity.max_attendees is number && 
                data.capacity.max_attendees > 0 && 
                data.capacity.max_attendees <= 1000
             ));
    }

    // --- Collection Rules ---

    // Users Collection
    // Users Collection
    // Anyone authenticated can read basic profile info (needed for displaying coach/venue/attendee details)
    // Only owner or admin can write
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId && isValidUser(request.resource.data);
      allow update: if (isOwner(userId) || isAdmin()) && isValidUser(request.resource.data);
      allow delete: if isOwner(userId) || isAdmin();
    }

    // Events Collection
    // Public read (for Explore view)
    // Only Venues/Coaches/Admins can write
    match /events/{eventId} {
      allow read: if true;
      allow create: if (isVenue() || isCoach() || isAdmin()) && isValidEvent(request.resource.data);
      allow update: if ((resource.data.organizerId == request.auth.uid) || isAdmin()) && isValidEvent(request.resource.data);
      allow delete: if (resource.data.organizerId == request.auth.uid) || isAdmin();
    }

    // Bookings Collection
    // Users can read/write their own bookings
    // Organizers (Venue/Coach) can read bookings for their events
    match /bookings/{bookingId} {
      // Allow read if you are the booker OR the organizer of the event
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || 
        resource.data.organizerId == request.auth.uid || 
        isAdmin()
      );
      
      // Allow create if you are the one booking AND data is valid
      allow create: if isAuthenticated() && 
                    request.resource.data.userId == request.auth.uid &&
                    isValidBooking(request.resource.data);
      
      // Allow update if data is valid AND:
      // 1. You are the booker and ONLY cancelling
      // 2. You are the organizer (management)
      // 3. You are an Admin
      allow update: if isAuthenticated() && 
                    isValidBooking(request.resource.data) && (
        (isOwner(resource.data.userId) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']) && request.resource.data.status == 'cancelled') ||
        resource.data.organizerId == request.auth.uid || 
        isAdmin()
      );
    }
    
    // Gigs Collection (Marketplace)
    // Read: Authenticated users
    // Write: Coaches/Venues/Admins
    match /gigs/{gigId} {
        allow read: if isAuthenticated();
        allow create: if isCoach() || isVenue() || isAdmin();
        allow update, delete: if (resource.data.posterId == request.auth.uid) || isAdmin();
    }

    // Venues Collection
    match /venues/{venueId} {
      allow read: if true; 
      allow create: if isVenue() || isAdmin();
      allow update, delete: if (resource.data.ownerId == request.auth.uid) || isAdmin();
    }
    
    // Messages/Chats (If implemented)
    // ...
  }
}
